{% comment %}
Theme App Block: React-basierter Sticker-Konfigurator

✅ Theme-Check konsistent clean:
- asset_url direkt im href/src (keine RemoteAsset Warnung durch Variablen)
- echte <script defer> Tags (kein ParserBlockingScript)
{% endcomment %}

{{ 'sticker-embed.css' | asset_url | stylesheet_tag }}

{% assign product_id = product.id %}
{% assign initial_variant_id = product.selected_or_first_available_variant.id %}

{%- comment -%}
Settings sauber aus dem Block ziehen (Theme-Check: keine UndefinedObject Warnungen)
- pricing_variant_id kommt aus block.settings
- shape_handles kommt aus block.settings (als JSON String)
{%- endcomment -%}
{% assign pricing_variant_id = block.settings.pricing_variant_id | default: initial_variant_id %}

{%- comment -%}
shape_handles:
- textarea enthält JSON (z.B. {"square":"square","oval":"oval"})
- Falls leer/ungültig: '{}' ausgeben
- escape sorgt dafür, dass Quotes im HTML-Attribut nicht brechen
{%- endcomment -%}
{% assign sc_shape_handles = block.settings.sc_shape_handles | default: '{}' %}

<div
  class="sticker-embed-root"
  data-product-id="{{ product_id }}"
  data-initial-variant-id="{{ initial_variant_id }}"
  data-pricing-variant-id="{{ pricing_variant_id }}"
  data-block-id="{{ block.id }}"
  data-section-id="{{ section.id }}"
  data-api-base="/apps/sticker-configurator"
  data-shape-handles='{{ sc_shape_handles | strip | escape }}'
>
  <button type="button" class="sticker-embed-button">
    {{ block.settings.button_label }}
  </button>

  <div class="sticker-embed-modal" aria-hidden="true">
    <div class="sticker-embed-backdrop"></div>

    <div class="sticker-embed-dialog">
      <button
        type="button"
        class="sticker-embed-close"
        aria-label="Schließen"
      >
        ×
      </button>

      <div class="sticker-embed-react-root"></div>
    </div>
  </div>
</div>

{%- comment -%}
✅ Scripts:
- defer => nicht parser-blocking
- asset_url DIREKT im src => Theme-Check RemoteAsset wird zuverlässig vermieden
{%- endcomment -%}
<script src="{{ 'sticker-configurator.js' | asset_url }}" defer></script>
<script src="{{ 'sticker-embed.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Sticker Konfigurator",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "button_label",
      "label": "Button-Text",
      "default": "Sticker designen"
    },
    {
      "type": "text",
      "id": "asset_version",
      "label": "Asset Version (Cache Busting)",
      "default": "1"
    },
    {
      "type": "number",
      "id": "pricing_variant_id",
      "label": "Preis-Token Variant-ID (0,01 € Variante)",
      "default": 52888318673242
    },
    {
      "type": "textarea",
      "id": "sc_shape_handles",
      "label": "Shape Handles (JSON)",
      "default": "{}",
      "info": "JSON-Objekt, z.B. {\"square\":\"square\",\"rect\":\"rect\",\"oval\":\"oval\",\"freeform\":\"freeform\"}"
    }
  ]
}
{% endschema %}
